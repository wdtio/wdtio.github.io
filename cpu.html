<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
  <link href='https://wdt.io/index.css' rel='stylesheet' type='text/css'>
  <title>Monitoring cpu utilization - WDT.io Cookbook</title>
  <link rel="apple-touch-icon" sizes="57x57" href="https://wdt.io/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://wdt.io/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="//wdt.io/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://wdt.io/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://wdt.io/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://wdt.io/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://wdt.io/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://wdt.io/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://wdt.io/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="https://wdt.io/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://wdt.io/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="https://wdt.io/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="https://wdt.io/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="https://wdt.io/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://wdt.io/manifest.json">
  <meta name="apple-mobile-web-app-title" content="WDTio">
  <meta name="application-name" content="WDTio">
  <meta name="msapplication-TileColor" content="#d9d4d2">
  <meta name="msapplication-TileImage" content="https://wdt.io/mstile-144x144.png">
  <meta name="theme-color" content="#d9d4d2">
  <style type="text/css">
  .index .bottom-link {
    display: none;
  }
  </style>
</head>
<body class="">
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display: none;">
    <defs>
      <g id="logo-basics">
        <path d="M112.864,383.158 C116.628,385.755 123.593,387.095 133.76,387.178 C125.645,389.182 117.811,388.515 110.26,385.178 C100.031,364.043 107.198,352.043 131.76,349.178 C132.427,320.844 130.927,291.844 130.26,264.178 C130.099,226.052 139.683,201.596 161.263,199.3 C93.544,176.658 79.878,141.658 120.263,94.3 C122.332,75.301 126.332,59.301 132.264,46.3 C127.924,43.264 126.778,40.421 126.263,39.456 C129.809,42.443 132.76,44.175 135.116,44.655 C139.764,39.234 144.431,35.234 149.116,32.655 C134.251,48.45 126.751,69.2 126.616,94.905 C85.855,139.429 98.678,173.596 163.116,197.406 C194.561,201.561 223.978,200.478 251.365,194.156 C230.09,202.717 200.757,205.217 163.365,201.656 C145.706,205.595 136.706,227.012 136.365,265.907 C136.698,321.24 136.865,348.907 136.865,348.907 C136.144,350.876 135.144,351.96 133.864,352.157 C115.212,353.824 108.322,364.249 112.864,383.158"/>
        <path d="M310.867,34.155 C307.176,43.081 300.142,40.63 289.763,26.801 C292.371,34.309 297.372,40.476 304.763,45.301 C313.512,46.56 317.679,42.394 317.263,32.801 C312.952,19.331 303.785,10.664 289.763,6.801 C283.368,5.697 275.868,10.697 267.263,21.801 C234.129,1.4 198.629,-0.267 160.763,16.801 C150.709,4.439 140.543,-0.728 130.263,1.301 C111.761,9.2 100.428,21.7 96.263,38.801 C101.499,52.571 113.999,50.738 133.763,33.301 C117.363,42.298 107.064,43.416 102.867,36.655 C110.344,18.258 121.01,8.258 134.867,6.655 C144.501,8.036 152.834,13.62 159.867,23.405 C194.841,6.746 229.925,7.413 265.117,25.406 C270.773,29.919 275.94,34.002 280.617,37.655 C274.784,28.822 271.867,24.405 271.867,24.405 C278.072,14.415 284.322,10.332 290.617,12.156 C303.785,18.675 310.535,26.008 310.867,34.155"/>
        <path d="M251.782,290.545 C252.334,283.764 255.097,276.912 260.07,269.99 C254.617,273.876 249.659,281.501 248.445,291.615 C249.609,297.91 257.068,300.785 267.57,301.49 C279.356,300.578 287.439,294.619 290.32,281.865 C290.32,281.865 301.403,280.199 323.57,274.49 C341.363,268.708 348.821,254.875 342.57,232.99 C334.009,206.834 310.657,193.271 280.763,192.301 C331.157,166.791 337.657,131.124 300.263,85.301 C299.482,73.88 297.149,59.88 293.263,43.301 C294.335,42.365 295.502,41.031 296.763,39.301 C295.9,38.37 295.345,37.659 295.099,37.167 C292.224,40.917 289.287,42.792 289.287,42.792 C292.324,54.74 294.553,69.094 295.972,85.854 C330.607,129.896 324.357,165.73 274.222,193.355 C309.349,196.052 330.266,209.261 336.971,232.981 C344.241,253.352 339.241,266.518 321.971,272.481 C309.7,275.486 298.617,277.57 288.721,278.731 C286.005,291.642 278.859,298.622 267.282,299.67 C259.302,298.683 254.135,295.642 251.782,290.545"/>
        <path d="M135.486,383.784 C138.928,386.267 145.602,387.315 155.51,386.928 C146.81,389.74 133.06,388.907 131.01,385.178 C126.819,371.61 133.07,355.276 145.76,352.928 C135.721,359.327 132.296,369.613 135.486,383.784"/>
        <path d="M158.485,383.285 C154.916,370.658 158.424,360.789 169.01,353.678 C156.32,356.026 150.069,372.359 154.26,385.928 C156.31,389.656 170.06,390.49 178.76,387.678 C189.082,389.212 194.727,387.4 195.695,382.24 C190.867,355.746 191.033,326.496 196.195,294.49 C199.486,292.495 202.999,292.926 206.735,295.785 C202.377,289.673 195.377,288.506 185.735,292.285 C189.411,293.254 192.077,294.004 193.735,294.535 C187.898,322.679 186.231,351.513 191.735,381.035 C190.272,385.62 186.939,386.954 178.735,385.035 C166.116,386.866 159.365,386.283 158.485,383.285"/>
        <path d="M231.462,283.8 C234.475,288.911 240.761,291.557 250.32,291.74 C239.89,294.516 232.64,292.099 228.57,284.49 C228.039,271.818 232.289,263.318 241.32,258.99 C233.885,265.906 230.599,274.177 231.462,283.8"/>
        <path d="M213.462,271.925 C214.935,276.827 219.888,280.599 228.32,283.24 C219.406,283.547 213.406,279.631 210.32,271.49 C210.484,256.595 214.234,245.928 224.069,240.49 C247.721,227.109 272.721,220.776 296.57,220.49 C270.981,223.006 247.612,230.567 226.463,243.174 C218.643,247.94 214.309,257.524 213.462,271.925"/>
        <path d="M283.57,293.989 C293.646,351.754 263.865,380.271 195.57,379.989 C272.189,383.031 301.522,354.364 283.57,293.989"/>
        <path d="M299.479,355.412 C297.832,358.574 299.362,363.849 300.32,370.738 C301.199,365.154 302.283,361.071 303.57,358.489 C338.506,320.953 336.236,294.286 300.07,278.489 C330.642,296.294 329.196,321.769 299.479,355.412"/>
        <path d="M232.854,385.288 C230.654,384.575 229.309,382.392 228.82,378.739 C228.25,382.349 228.75,385.349 230.32,387.739 C233.411,391.761 250.078,393.428 280.32,392.739 C302.964,391.911 325.381,394.078 347.57,399.239 C356.336,389.956 357.753,381.039 351.82,372.489 C345.221,368.014 336.721,367.348 326.32,370.488 C339.905,369.169 347.916,372.019 350.355,379.038 C350.461,386.637 348.211,391.637 343.605,394.038 C319.173,389.907 298.09,388.574 280.354,390.038 C252.538,389.907 236.704,388.324 232.854,385.288"/>
        <path d="M369.086,392.677 C364.285,393.005 357.363,394.275 351.32,395.239 C360.856,395.72 367.856,395.387 372.32,394.239 C377.571,375.995 375.238,365.495 365.32,362.739 C361.345,361.46 356.345,361.377 350.32,362.489 C368.954,361.194 374.46,371.09 369.086,392.677"/>
        <path d="M382.711,388.801 C380.208,389.197 376.994,389.76 373.07,390.488 C378.908,390.4 382.991,390.234 385.32,389.988 C392.755,372.904 392.921,360.321 384.821,354.738 C375.383,348.67 364.049,347.503 351.82,352.238 C335.924,354.211 322.174,355.378 309.07,352.238 C323.511,356.678 337.892,358.282 352.211,357.051 C365.615,351.83 375.948,352.497 383.211,359.052 C388.777,365.856 388.611,375.773 382.711,388.801"/>
        <path d="M191.252,103.53 C198.593,104.11 202.15,111.664 203.811,117.982 C205.929,127.13 203.283,135.554 197.903,136.799 C192.522,138.045 186.444,131.639 184.327,122.492 C182.21,113.345 184.856,104.921 190.236,103.675 L191.252,103.53 z M197.244,113.788 L196.269,113.844 C193.699,114.439 192.435,118.463 193.446,122.831 C194.457,127.2 197.36,130.259 199.93,129.665 C202.5,129.07 203.763,125.046 202.752,120.677 C202.147,118.405 201.173,116.022 199.183,114.593 C198.614,114.184 197.89,114.056 197.244,113.788 z"/>
        <path d="M253.189,74.157 C256.496,74.244 259.307,75.585 262.048,77.28 C279.448,88.965 276.531,119.799 256.298,137.53 C248.515,142.399 242.348,140.732 234.798,132.53 C225.961,118.348 225.461,103.764 233.298,88.78 C237.199,82.783 242.164,76.256 249.545,74.525 C250.734,74.246 251.974,74.279 253.189,74.157 z M251.206,109.056 C248.296,108.768 245.539,112.544 245.048,117.492 C244.558,122.44 246.519,126.684 249.429,126.973 C252.34,127.261 255.097,123.485 255.587,118.537 C256.078,113.59 254.117,109.345 251.206,109.056 z"/>
        <path d="M103.585,348.052 C104.831,352.371 104.924,356.933 103.864,361.738 C102.985,356.154 101.902,352.071 100.614,349.488 C68.902,311.953 67.068,283.286 101.114,267.488 C112.22,263.258 124.454,265.424 131.819,269.987 C121.809,267.181 112.565,268.036 104.085,272.552 C77.175,288.18 77.008,313.347 103.585,348.052"/>
        <path d="M51.709,387.863 C72.984,384.171 91.619,383.498 107.614,385.845 C82.436,384.925 73.912,386.5 49.24,392.238 C39.493,381.917 37.418,371.003 44.515,362.495 C51.602,356.395 61.303,356.779 72.868,360.271 C59.266,358.896 50.499,359.212 46.567,365.347 C42.854,375.164 45.568,382.669 51.709,387.863"/>
        <path d="M24.468,383.972 C28.702,385.041 35.57,386.314 45.07,387.791 C34.468,388.326 26.685,387.956 21.721,386.679 C15.883,366.394 18.477,354.72 29.504,351.654 C33.924,350.233 39.483,350.141 46.183,351.376 C39.726,351.114 34.341,352.065 30.027,354.229 C22.789,358.369 20.936,368.283 24.468,383.972"/>
        <path d="M8.901,378.691 C11.962,380.258 15.957,381.531 20.887,382.509 C14.396,382.411 9.856,382.226 7.266,381.953 C-1,362.958 -2.504,346.731 6.503,340.524 C16.996,333.777 31.417,333.41 46.014,340.675 C63.689,342.868 77.061,343.47 91.631,339.979 C80.692,345.222 64.883,346.914 44.204,345.056 C31.709,339.447 19.655,339.063 10.291,347.28 C4.607,354.377 4.144,364.847 8.901,378.691"/>
        <path d="M224.838,157.469 C227.618,157.366 230.047,157.031 232.126,156.462 C236.829,154.116 238.709,150.26 237.767,144.895 C230.327,142.944 222.126,143.836 213.163,147.573 C215.017,153.932 218.909,157.231 224.838,157.469"/>
        <path d="M75.332,220.304 C69.927,237.924 75.631,256.403 92.443,275.739 C64.245,255.722 57.448,231.723 77.942,203.739 C76.726,211.159 78.726,218.159 83.943,224.739 C86.16,213.42 92.994,204.92 104.442,199.239 C91.882,225.266 98.049,247.6 122.942,266.239 C100.076,252.657 90.872,234.512 95.332,211.804 C90.294,216.203 86.461,223.37 83.832,233.304 C79.145,229.06 76.312,224.727 75.332,220.304"/>
        <path d="M283.17,229.158 C294.768,229.158 304.17,234.083 304.17,240.158 L304.17,243.658 C304.117,247.056 301.485,249.922 296.272,252.254 C286.89,255.428 278.202,255.447 270.208,252.313 C264.922,249.998 262.243,247.113 262.17,243.658 L262.17,240.158 C262.17,234.083 271.572,229.158 283.17,229.158 z M283.294,231.24 C273.284,231.24 265.168,235.008 265.168,239.656 C265.168,244.304 273.284,248.072 283.294,248.072 C293.305,248.072 301.42,244.304 301.42,239.656 C301.42,235.008 293.305,231.24 283.294,231.24 z"/>
        <path d="M300.07,278.489 C306.505,277.667 310.439,277.079 311.874,276.726 C309.788,264.095 305.511,254.91 299.04,249.172 C296.73,251.082 292.578,252.464 286.584,253.318 C293.305,256.926 297.8,265.316 300.07,278.489"/>
        <path d="M265.69,234.059 C271.088,232.395 276.492,230.768 281.903,229.177 C279.485,227.638 276.829,225.887 273.936,223.923 C270.196,224.546 264.362,226.075 256.434,228.508 C258.976,228.994 262.062,230.844 265.69,234.059"/>
        <path d="M261.512,175.375 C261.306,175.359 261.202,175.338 261.199,175.312 C255.366,182.024 245.157,183.982 230.573,181.187 C218.356,186.234 206.522,185.692 195.073,179.562 C195.073,179.562 194.573,180.02 193.573,180.937 C193.684,178.209 195.319,175.198 197.292,174.593 C196.877,175.053 196.585,175.678 196.417,176.468 C206.917,182.669 217.824,184.512 230.323,179.312 C243.235,182.648 252.735,179.919 259.824,173.249 C258.907,172.583 258.448,172.25 258.448,172.25 C260.822,171.941 262.697,173.921 263.073,176.063 C262.47,175.679 261.949,175.45 261.512,175.375"/>
      </g>
      <g id="logo-details">
        <path d="M332.525,238.92 C339.656,253.641 335.781,264.396 317.345,266.172 L315.246,266.245 C317.62,265.528 317.7,265.56 319.059,264.841 C331.547,258.235 335.129,252.255 332.525,238.92"/>
        <path d="M166.77,209.296 C151.568,217.232 149.508,243.334 146.882,258.971 C145.252,268.674 144.739,278.271 144.337,288.073 C142.599,265.398 141.063,219.09 166.77,209.296"/>
        <path d="M107.242,32.744 C115.432,21.186 126.727,6.557 142.997,13.042 C145.54,14.056 146.962,15.505 148.993,17.244 C133.89,8.863 117.955,22.72 107.242,32.744"/>
        <path d="M279.492,18.744 C287.7,10.293 296.4,15.742 301.767,24.94 L304.492,30.244 C299.163,24.989 299.418,25.085 296.422,23.032 C290.737,19.137 286.251,15.205 279.492,18.744"/>
        <path d="M95.324,324.561 C89.556,293.291 100.056,276.458 126.824,274.061 C96.256,274.158 85.756,290.991 95.324,324.561"/>
        <path d="M300.824,287.561 C315.254,298.006 316.088,316.506 303.324,343.061 C320.847,315.019 320.013,296.52 300.824,287.561"/>
        <path d="M131.074,99.311 C104.706,135.132 110.372,164.465 148.074,187.311 C104.652,162.69 98.986,133.357 131.074,99.311"/>
        <path d="M80.074,233.311 C80.285,248.628 86.535,258.795 98.824,263.812 C88.456,256.058 82.206,245.891 80.074,233.311"/>
        <path d="M157.726,34.05 C145.72,46.738 138.053,66.072 134.726,92.05 C134.995,63.475 142.662,44.141 157.726,34.05"/>
        <path d="M188.127,209.026 C217.539,216.104 241.725,213.209 260.686,200.341 C237.02,208.911 212.833,211.807 188.127,209.026"/>
        <path d="M277.205,309.932 C278.867,340.477 261.58,360.977 225.343,371.432 C266.089,362.762 283.376,342.262 277.205,309.932"/>
        <path d="M292.842,90.433 C315.567,124.544 314.4,153.044 289.342,175.933 C318.366,152.883 319.533,124.383 292.842,90.433"/>
      </g>
      <g id="logo-text">
        <path d="M745.412,101 L745.412,301"/>
        <path d="M681,101 L806,101"/>
        <path d="M693,201 C693,145.772 663.898,101 628,101 L568,101 L568,301 L628,301 C663.898,301 693,256.228 693,201" stroke-linejoin="bevel"/>
        <path d="M546.057,100 L501.943,300 L457.728,100 L413.614,300 L369.398,100" stroke-linejoin="round"/>
        <path d="M793,226 L793,301"/>
        <path d="M850.5,301 C833.931,301 820.5,284.211 820.5,263.5 C820.5,242.789 833.931,226 850.5,226 C867.069,226 880.5,242.789 880.5,263.5 C880.5,284.211 867.069,301 850.5,301 z"/>
        <path d="M793,201 L793,206"/>
      </g>
    </defs>
  </svg>

  <div id="app">
    <div>
      <header>
        <div class="logo">
          <a href="https://wdt.io"><svg viewBox='0, 0, 885, 400'><use xlink:href='#logo-basics' /><use xlink:href='#logo-text' class='logo-text' /></svg></a>
        </div>
        <div class="clock">
        </div>
        <div class="menu">
          <h1><a href="/">Cookbook<span class="header-wide"> Index</span></a></h1>
        </div>
      </header>
      <main class="cookbook">
        <section class="recipe">
          <h2>How to monitor CPU utilization</h2>
          <p>Even though WDT.io is just a simple watchdog timer that only understands HTTP, it can be used to monitor available system resources. Here we'll focus on monitoring the processor (CPU).</p>
<p>When a server utilizes it processor's cores to the maximum, it doesn't have enough spare cycles to process new jobs and will feel slow. When the CPU usage stays at 100%, the machine is essentially unresponsive. A rule of thumb is to stay below 80% but that limit depends on many factors such as duration and intensity of peak usage. Whatever maximum CPU usage you're comfortable with, you should monitor this maximum so you can upgrade your hardware or optimize your software when that maximum is reached.</p>
<p>The general idea is to create a cron job that compares the average CPU usage over some time to a maximum value. The cron job then kicks a watchdog timer if the usage is below the maximum. Now if the usage is above that maximum, WDT.io won't get kicked and sends out an alert.</p>
<p><strong>top</strong> is a standard unix command that displays processes and the resources used. Used with the options <code>-bn 2 -d 1</code> it operates in batch mode (instead of being interactive), twice, and with a delay of one second. Piping the output through <code>grep '^%Cpu'</code> will capture just the two lines about total CPU utilization. The first line is the average since reboot, and the second line is the average during the one second we're letting <code>top</code> run. We can use <code>tail -n 1</code> to capture that second line, which will look something like the following.</p>
<pre><code class="language-bash">%Cpu(s):  3.8 us,  0.6 sy,  0.0 ni, 94.2 id,  0.2 wa,  0.0 hi,  0.2 si,  1.0 st
</code></pre>
<p>The values we're most interested in are <strong>us</strong> (CPU time spent in user space), <strong>sy</strong> (CPU time spent in kernel space), and <strong>ni</strong> (CPU time spent on low priority processes). We can add them up and floor the result into a comparable integer with <code>awk '{print int($2+$4+$6)}'</code>. All together we have</p>
<pre><code class="language-bash">top -bn 2 -d 1 | grep '^%Cpu' | tail -n 1 | awk '{print int($2+$4+$6)}'
</code></pre>
<p>Let's decide that we want to monitor every 2 minutes and that the maximum CPU usage is 80%.</p>
<ol>
<li><a href="https://wdt.io/signup">Sign up</a> on WDT.io if you haven't already</li>
<li><a href="inbound_timer.html">Create</a> a new inbound timer &quot;cpu&quot; with a schedule of every 2 minutes +30 seconds tolerance</li>
<li>Copy the URL of this new timer</li>
<li>Edit the crontab and add this line:</li>
</ol>
<pre><code class="language-bash">*/2 * * * * ((`top -bn 2 -d 1 | grep '^%Cpu' | tail -n 1 | awk '{print int($2+$4+$6)}'` &lt; 80)) &amp;&amp; curl -sm 30 &lt;the URL from step 3&gt;
</code></pre>
<p>Now we'll be notified when the CPU is used too much (or the cronjob fails) and can deal with whatever caused the problem.</p>
<h3>More info</h3>
<ul>
<li><a href="http://linux.die.net/man/1/top">man page for top</a></li>
<li><a href="http://linux.die.net/man/1/grep">man page for grep</a></li>
<li><a href="http://linux.die.net/man/1/tail">man page for tail</a></li>
<li><a href="http://linux.die.net/man/1/awk">man page for awk</a></li>
<li><a href="http://linux.die.net/man/5/crontab">man page for cron</a></li>
<li><a href="http://linux.die.net/man/1/curl">man page for curl</a></li>
</ul>

        </section>
        <span class="links bottom-link"><a href='/'>More Recipes</a></span>

      </main>
      <footer class="links">
        <span>©&nbsp;2016&nbsp;WDT.io&nbsp;Inc.</span>
        <span><a href='mailto:info@wdt.io'>info@wdt.io</a></span>
      </footer>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', window.main);
    var _paq = _paq || [];
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    window.addEventListener('load', function() {
      var u="//wdtstats.wdt.io/piwik/";
      _paq.push(['setTrackerUrl', u+'piwik.php']);
      _paq.push(['setSiteId', 3]);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    });
  </script>
</body>
</html>
